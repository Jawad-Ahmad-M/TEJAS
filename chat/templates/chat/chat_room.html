{% extends 'base.html' %}
{% load static %}

{% block title %}Chat with {% for part in conversation.participants.all %}{% if part != user %}{{ part.username }}{% endif %}{% endfor %} - TEJAS{% endblock %}

{% block extra_css %}
<style>
    :root {
        --chat-glass: rgba(255, 255, 255, 0.03);
        --chat-border: rgba(255, 255, 255, 0.08);
    }

    .chat-room-container {
        height: calc(100vh - 240px);
        min-height: 600px;
        background: var(--chat-glass);
        backdrop-filter: blur(30px);
        border: 1px solid var(--chat-border);
        border-radius: 30px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.6);
        position: relative;
    }

    #chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 2.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        scroll-behavior: smooth;
        scrollbar-width: none; /* Hide for cleanliness */
    }
    
    #chat-messages::-webkit-scrollbar { display: none; }

    .message-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 75%;
        animation: messageSlideIn 0.4s cubic-bezier(0, 0, 0.2, 1) forwards;
        opacity: 0;
    }

    @keyframes messageSlideIn {
        from { transform: translateY(20px) scale(0.95); opacity: 0; }
        to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .message-sent { align-self: flex-end; align-items: flex-end; }
    .message-received { align-self: flex-start; align-items: flex-start; }

    .message-bubble {
        padding: 1rem 1.5rem;
        border-radius: 20px;
        font-size: 1rem;
        line-height: 1.6;
        position: relative;
        font-weight: 500;
    }

    .message-sent .message-bubble {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-bottom-right-radius: 4px;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
    }

    .message-received .message-bubble {
        background: rgba(255, 255, 255, 0.07);
        color: #f8fafc;
        border-bottom-left-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }
    
    .chat-input-area {
        padding: 2rem;
        background: rgba(0, 0, 0, 0.3);
        border-top: 1px solid var(--chat-border);
        backdrop-filter: blur(10px);
    }

    .input-box-wrapper {
        position: relative;
        display: flex;
        gap: 12px;
    }

    .input-box {
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1.5px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 12px !important; /* Standard 12px */
        padding: 18px 25px !important;
        color: white !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        font-size: 1rem !important;
    }

    .input-box:focus {
        background: rgba(255, 255, 255, 0.08) !important;
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.2) !important;
    }

    .btn-send {
        width: 60px;
        height: 60px;
        border-radius: 12px !important; /* Standard 12px */
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }

    .btn-send:hover:not(:disabled) {
        transform: scale(1.05) rotate(-5deg);
        box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);
    }

    .timestamp {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.3);
        margin-top: 0.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .chat-header-glass {
        padding: 1.5rem 2.5rem;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid var(--chat-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .avatar-mini {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        display: flex; align-items: center; justify-content: center;
        font-weight: 800; color: white;
        font-size: 1.2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Chat Header Outside -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div class="d-flex align-items-center gap-3">
            <a href="{% url 'chat:chat_list' %}" class="btn btn-dark rounded-circle d-flex align-items-center justify-content-center" style="width: 44px; height: 44px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                <i class="fas fa-chevron-left text-slate-400"></i>
            </a>
            <div>
                <h2 class="h4 font-bold text-white mb-0">
                    {% for part in conversation.participants.all %}{% if part != user %}{{ part.username }}{% endif %}{% endfor %}
                </h2>
                {% if conversation.tender %}
                <div class="d-flex align-items-center gap-2">
                     <span class="text-xs bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded border border-blue-500/20">Tender Context</span>
                     <span class="text-xs text-slate-500 font-medium">{{ conversation.tender.title|truncatechars:40 }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="dropdown">
            <button class="btn btn-link text-slate-400 p-0" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end bg-slate-900 border-white/5">
                <li><a class="dropdown-item text-xs" href="#"><i class="fas fa-info-circle me-2"></i>View Profile</a></li>
                <li><hr class="dropdown-divider border-white/5"></li>
                <li><a class="dropdown-item text-xs text-danger" href="#"><i class="fas fa-ban me-2"></i>Report User</a></li>
            </ul>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="chat-room-container position-relative">
        
        <!-- Chat Header Internal -->
        <div class="chat-header-glass">
            <div class="d-flex align-items-center gap-3">
                <div class="avatar-mini">
                    {% for part in conversation.participants.all %}{% if part != user %}{{ part.username|slice:":1"|upper }}{% endif %}{% endfor %}
                </div>
                <div>
                    <h4 class="text-white font-extrabold mb-0" style="font-size: 1.2rem;">
                        {% for part in conversation.participants.all %}{% if part != user %}{{ part.username }}{% endif %}{% endfor %}
                    </h4>
                    {% if conversation.tender %}
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-xxs text-blue-400 font-bold uppercase tracking-wider">Tender:</span>
                        <span class="text-xxs text-slate-400">{{ conversation.tender.title|truncatechars:30 }}</span>
                    </div>
                    {% else %}
                        <span class="text-xxs text-green-500 font-bold uppercase tracking-wider">Secure Direct Message</span>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-dark rounded-xl p-2 px-3 border-white/10" title="Secure Link Info"><i class="fas fa-shield-alt text-blue-400"></i></button>
            </div>
        </div>

        {% if is_pending %}
        <div class="pending-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px); z-index: 50;">
            <div class="text-center p-5 glass-panel border-blue-500/20" style="max-width: 460px; background: rgba(15, 23, 42, 0.9);">
                <div class="mb-4">
                    <i class="fas fa-lock-open fa-4x text-blue-500 opacity-50"></i>
                </div>
                {% if is_initiator %}
                    <h4 class="text-white font-extrabold mb-3">Awaiting Approval</h4>
                    <p class="text-slate-400 text-sm mb-0">Your secure connection request has been sent. Messaging will be available once accepted.</p>
                {% else %}
                    <h4 class="text-white font-extrabold mb-3">New Channel Invitation</h4>
                    <p class="text-slate-400 text-sm mb-4">A user has requested to open a secure communication channel with you.</p>
                    <div class="d-flex gap-3 justify-content-center">
                        <form method="POST" action="{% url 'chat:accept_chat' conversation.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-gradient rounded-xl px-4 py-2 font-extrabold">Accept Request</button>
                        </form>
                        <form method="POST" action="{% url 'chat:reject_chat' conversation.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger rounded-xl px-4 py-2 font-extrabold">Decline</button>
                        </form>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div id="chat-messages">
            {% for message in chat_messages %}
            <div class="message-wrapper {% if message.sender == user %}message-sent{% else %}message-received{% endif %}">
                <div class="message-bubble">
                    {{ message.text }}
                </div>
                <span class="timestamp">{{ message.timestamp|date:"H:i" }}</span>
            </div>
            {% endfor %}
        </div>

        <!-- Input Area -->
        <div class="chat-input-area">
            <div class="input-box-wrapper">
                <input type="text" id="chat-message-input" class="form-control input-box" placeholder="Write a secure message..." {% if is_pending %}disabled{% endif %}>
                <button id="chat-message-submit" class="btn-send" {% if is_pending %}disabled{% endif %}>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ conversation.id|json_script:"conversation-id" }}
{{ user.username|json_script:"user-username" }}
{{ user.id|json_script:"user-id" }}
<script>
    const conversationId = JSON.parse(document.getElementById('conversation-id').textContent);
    const userUsername = JSON.parse(document.getElementById('user-username').textContent);
    const currentUserId = JSON.parse(document.getElementById('user-id').textContent);

    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + 
        window.location.host + '/ws/chat/' + conversationId + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'status_update' && data.status === 'ACCEPTED') {
            // Real-time refresh when chat is accepted
            const overlay = document.querySelector('.pending-overlay');
            if (overlay) overlay.remove();
            
            const input = document.querySelector('#chat-message-input');
            const submit = document.querySelector('#chat-message-submit');
            if (input) input.disabled = false;
            if (submit) submit.disabled = false;
            return;
        }

        if (data.error) {
            alert(data.error);
            return;
        }
        
        const messagesDiv = document.querySelector('#chat-messages');
        const isMe = data.sender_id === currentUserId || data.sender_username === userUsername;
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
        
        const messageHtml = `
            <div class="message-wrapper ${isMe ? 'message-sent' : 'message-received'}">
                <div class="message-bubble">
                    ${data.message}
                </div>
                <span class="timestamp">${time}</span>
            </div>
        `;
        
        messagesDiv.innerHTML += messageHtml;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    };

    const inputDom = document.querySelector('#chat-message-input');
    const submitBtn = document.querySelector('#chat-message-submit');

    if (inputDom) {
        inputDom.focus();
        inputDom.onkeyup = function(e) {
            if (e.keyCode === 13) { submitBtn.click(); }
        };
    }

    if (submitBtn) {
        submitBtn.onclick = function(e) {
            const message = inputDom.value.trim();
            if (message === '') return;
            
            chatSocket.send(JSON.stringify({
                'message': message,
                'sender_id': currentUserId
            }));
            inputDom.value = '';
        };
    }

    // Initial scroll
    const messagesDiv = document.querySelector('#chat-messages');
    if (messagesDiv) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
{% endblock %}
